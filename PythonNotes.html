<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Python Notes</title>
    <meta name="generator" content="emacs-wiki.el" />
    <meta http-equiv="Content-Type"
          content="text/html; charset=utf-8" />
    <link rel="made" href="mailto:cyberpsyche[AT]gmail.com" />
    <link rel="home" href="WelcomePage.html" />
    <link rel="index" href="WikiIndex.html" />
    <link rel="stylesheet" type="text/css" href="main.css"><script type="text/javascript">
function showToolTip(machaine) {
  if (machaine != "")   {
    document.getElementById('tooltip').innerHTML     = machaine;
    document.getElementById('tooltipbox').style.visibility = 'visible';
  }
}
function hide() {
  document.getElementById('tooltip').innerHTML     = '';
  document.getElementById('tooltipbox').style.visibility = 'hidden';
}
</script>
<div class="menu">
<div class="menuitem">
  <a href="WelcomePage.html">Wiki</a>
</div>

<div class="menuitem">
  <a href="../workwiki/WelcomePage.html">work</a>
</div>

</div><!-- menu ends here -->
<div id="tooltipbox">
<div id="tooltip"></div>
</div>
  </head>
  <body>
    <h1 id="top">Python Notes</h1>

    <!-- Page published by Emacs Wiki begins here -->
<h3>python programming</h3>

<h4>exec  and  eval</h4>

<pre class="example">&gt;&gt;&gt; d = {}
&gt;&gt;&gt; exec(file('~/Test/python/test.py'), d)
&gt;&gt;&gt; d.get('func')(1)
等于
&gt;&gt;&gt; eval('func(1)', d)
</pre>

<h4>logging 工具</h4>

<p>
用于调试

</p>

<h4>python -i  or  ipython </h4>

<p>
交互模式

</p>

<h4>用dict模拟switch语句</h4>

<pre class="example">&gt;&gt;&gt; d={'1':lambda x:x+1,'2':lambda x:x+2,'3':lambda x:x+3}
&gt;&gt;&gt; d['2'](10)
12
&gt;&gt;&gt; d['3'](10)
13
</pre>

<h4>append to file</h4>

<p>
use "a" mode to open a file.

</p>

<h3>python modules</h3>

<h4>HTML/XML  parser</h4>

<p>
Beautiful Soup

</p>

<p>
<a href="http://www.crummy.com/software/BeautifulSoup/">http://www.crummy.com/software/BeautifulSoup/</a>

</p>

<h4>JPype</h4>

<p>
JPype is an effort to allow python programs full access to java class libs.

</p>

<p>
<a href="http://jpype.sourceforge.net">http://jpype.sourceforge.net</a>

</p>

<p>
Python seems to be the greatest glue language I've ever saw.

</p>

<h4>json</h4>

<p>
simplejson  <a href="http://pypi.python.org/pypi/simplejson">http://pypi.python.org/pypi/simplejson</a>

</p>

<h4>pdb</h4>

<p>
debug tools. 

</p>

<p>
usage:

</p>

<pre class="example">python -m pdb mymodule.py
</pre>

<p>
or 

</p>

<pre class="example">&gt;&gt;&gt; import pdb
&gt;&gt;&gt; import mymodule
&gt;&gt;&gt; pdb.run(‘mymodule.test()’)
</pre>

<h4>MS SQL and Sybase</h4>

<p>
需要安装以下的modules:

</p>

<p>
<strong>libct3</strong>  -------- 基本库

</p>

<p>
<strong>libsybdb5</strong>  --------- 库文件

</p>

<p>
<strong>freetds-dev</strong>   ----------- 库文件和头文件

</p>

<p>
<strong>sqsh</strong>  ----------- 基于freetds的命令行ms sql / sybase 查询工具

</p>

<p>
MSSQL module for Python

</p>

<p>
<a href="http://www.object-craft.com.au/projects/mssql/">http://www.object-craft.com.au/projects/mssql/</a>

</p>

<p>
下载 mssql-0.9

</p>

<dl>
<dt>安装命令</dt>
<dd>
python setup.py install
</dd>
</dl>

<h4>feedparser</h4>

<p>
<a href="http://feedparser.org/">http://feedparser.org/</a>

</p>

<h4>celementtree</h4>

<p>
cElementTree为elementtree的改进版。

</p>

<pre class="example">for event, elem in ElementTree.iterparse(XML_FILE):
    if elem.tag == 'item':
        #elem.clear()
        print elem.attrib.get(&quot;id&quot;)
        title = elem.text
</pre>

<h4>Scientific Python</h4>

<p>
运行效率 numpy > numarray > numeric，其中numeric已经不维护，numarray官方也建议用户迁移至numpy。

</p>

<h4>GStreamer</h4>

<p>
多媒体框架。

</p>

<h4>Kivy</h4>

<p>
可视化框架。

</p>

<h3>Numpy</h3>

<h4>numpy连接数组</h4>

<p>
concatenate	连接沿现有轴的数组序列

</p>

<p>
stack	沿着新的轴加入一系列数组。

</p>

<p>
hstack	水平堆叠序列中的数组（列方向）

</p>

<p>
vstack	竖直堆叠序列中的数组（行方向）

</p>

<h4>numpy分割数组</h4>

<p>
split	将一个数组分割为多个子数组

</p>

<p>
hsplit	将一个数组水平分割为多个子数组（按列）

</p>

<p>
vsplit	将一个数组垂直分割为多个子数组（按行）

</p>

<h3>Python on Nokia Series 60</h3>

<h4>Platform </h4>
Install the python for series 60 SIS file into the mobilephone (I have a Nokia N-Gage QD) based on Symbian operating system, and you will find a symbolic icon of PYTHON enlisted on the menu board. You can triger a interactive python console or run python-scripts in your cellphone. Nokia and Symbian provided API for this programming environment.

</p>

<p>
If you want to build a develope environment on your PC, your should install a SDK from Nokia:

</p>

<p>
<a href="http://www.forum.nokia.com/main/1%2c6566%2c034-821%2c00.html">http://www.forum.nokia.com/main/1&#44;6566&#44;034-821&#44;00.html</a>

</p>

<p>
And you can also find a Developer Discussion Board of Python on that page.

</p>

<h3>Python Encoding</h3>

<h4>Using GB2312 coding in python scripts</h4>

<pre class="example">#!/usr/bin/python
# -*- coding: gb2312 -*-
</pre>

<p>
已上code的声明方法等价于：

</p>

<pre class="example"># coding=gb2312
or
# coding:gb2312
</pre>

<h4>Python 编码</h4>

<p>
python的编码可分为普通的str型和unicode型两种。

</p>

<pre class="example">&gt;&gt;&gt; a = '财神'
&gt;&gt;&gt; a
'\xe8\xb4\xa2\xe7\xa5\x9e'
&gt;&gt;&gt; b = unicode(a, 'utf-8')
&gt;&gt;&gt; b
u'\u8d22\u795e'
&gt;&gt;&gt; type(a)
&lt;type 'str'&gt;
&gt;&gt;&gt; type(b)
&lt;type 'unicode'&gt;
</pre>

<p>
unicode型的字符串不能直接存贮，需要转义为str型才行。

</p>

<pre class="example">&gt;&gt;&gt; b.encode('utf-8')
'\xe8\xb4\xa2\xe7\xa5\x9e'
</pre>

<p>
用 print a 显示原字串。

</p>

<h4>Python编码处理</h4>

<pre class="example">reload(sys)
sys.setdefaultencoding('utf8')
</pre>

<h3>Python Database Operation</h3>

<h4>Access MySQL datapool</h4>

<pre class="example">import MySQLdb

connection = MySQLdb.connect(host=&quot;xxx.xxx.xxx.xxx&quot;, db=&quot;dbname&quot;, port=3306,\
                           user=&quot;root&quot;, passwd=&quot;let_me_in&quot;)
con = connection.cursor()
try:
      sql_statement=&quot;select bush,rice from assholes order by stupid limit 2&quot;
      con.execute(sql_statement)
      con.scroll(0)

      i = 0
      while i &lt; con.rowcount :
             row = con.fetchone()
             stupid[i] = ''.join(&quot;%s&quot; % row[0])
             i += 1
except:
      status = &quot;Damn,MySQLdb query situation is elusive.&quot;

connection.close()
</pre>

<h3>Python Image Library</h3>

<h4>PIL exclusive pilfont creation</h4>

<pre class="example">otf2bdf -p 16 arial.ttf &gt; arial.bdf
python pilfont.py arial.bdf
</pre>

<p>
Then you can get arial.pbm and arial.pil, use them like this:

</p>

<pre class="example">font = ImageFont.load(&quot;arial.pil&quot;)
draw.text((10, 25), &quot;Hello World!&quot;, font=font)
</pre>

<h4>Draw Chinese characters with PIL </h4>

<pre class="example">font = ImageFont.truetype(&quot;/usr/share/fonts/truetype/mac-os-x/stheiti.ttf&quot;, 48)
draw.text((10, 25),unicode('你好，世界。 100℃', 'utf-8'), font=font, fill=&quot;#FF0000&quot;)
</pre>

<h3>Python Shell</h3>

<h4>交互模式下执行脚本</h4>

<pre class="example">&gt;&gt;&gt; os.system('demo.py')
or 
&gt;&gt;&gt; import demo
</pre>

<h4>import search path</h4>

<p>
方法一：

</p>

<pre class="example">export PYTHONPATH=&quot;/path/to/python/packages/&quot;
python want_to_exec.py
</pre>

<p>
方法二：

</p>

<pre class="example">sys.path.append('/path/to/pythoh/packages/')
os.system('want_to_exec.py')
</pre>

<h4>Python Pipe</h4>

<pre class="example">import os
s = os.popen('wget -O - http://www.google.com').read()
</pre>

<h4>python tip</h4>

<pre class="example">&gt;&gt;&gt; def f(a, **k):
...     print a
...     print k
... 
&gt;&gt;&gt; f(c=1, a=1, b=&quot;aaa&quot;)
output :
1
{'c': 1, 'b': 'aaa'}
</pre>

<h3>Python FTP </h3>

<pre class="example">from ftplib import FTP
import sys
ftp=FTP()
ftp.set_debuglevel(2)
ftp.connect('ftp.i139.cn','21')
ftp.login('weather','As!weath%erPire')
print ftp.getwelcome()
ftp.cwd('/')
bufsize = 1024
filename=sys.argv[1]
file_handler = open(filename,'rb')
#ftp.sendcmd('prompt')
ftp.set_pasv(1)
ftp.storbinary('STOR '+filename,file_handler,bufsize) #Upload file
ftp.set_debuglevel 
file_handler.close() #Close file
ftp.quit
</pre>

<h3>Django</h3>

<h4>Install Django</h4>

<pre class="example">python setup.py install
</pre>

<h4>Create a new project</h4>

<pre class="example">django-admin.py startproject &lt;prj-name&gt;
</pre>

<p>
admonition : a django project is comprised of some apps, u can adjust the apps in settins.py file INSTALLD_APPS section.

</p>

<h4>Create database tables</h4>

<pre class="example">python manage.py syncdb
</pre>

<p>
admonition : u can create a auth user in this procession. and u can execute this command anytime as you want, it would create any new tables after your last ran.

</p>

<h4>Run the testing server</h4>

<pre class="example">python manager.py runserver &lt;PORT&gt;
</pre>

<p>
admonition : PORT default is 8000 

</p>

<h4>Create app</h4>

<pre class="example">python manage.py startapp &lt;app-name&gt;
</pre>

<p>
then edit the models.py, for example

</p>

<pre class="example">from django.db import models

# Create your models here.
class CreateTag(models.Model):
        tagname = models.CharField(maxlength=100)
        pub_date = models.DateTimeField('date published')

class VoteTag(models.Model):
        tag = models.ForeignKey(CreateTag)
        pros = models.IntegerField()
        cons = models.IntegerField()

class CommentTag(models.Model):
        tag = models.ForeignKey(CreateTag)
        comment = models.CharField(maxlength=4000)

class ViewTag(models.Model):
        tag = models.ForeignKey(CreateTag)
        views = models.IntegerField()
</pre>

<p>
and u should insert the added app into project's settings.py file INSTALLED_APPS section.

</p>

<pre class="example">INSTALLED_APPS = (
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.sites',
    'prj-name.app-name'
)
</pre>

<h4>Check the sql of your app models</h4>

<p>
Output the sql of app models

</p>

<pre class="example">python manage.py sql app-name
</pre>

<p>
Checks for any error in your construction of models

</p>

<pre class="example">python manage.py validate app-name
</pre>

<p>
Outputs any initial data required for Django's admin framework and your models.

</p>

<pre class="example">python manage.py sqlinitialdata app-name
</pre>

<p>
Outputs the necessary &ldquo;DROP TABLE&ldquo; statements for this app, according to which tables already exist in your database (if any).

</p>

<pre class="example">python manage.py sqlclear app-name
</pre>

<p>
Outputs the &ldquo;CREATE INDEX&ldquo; statements for this app.

</p>

<pre class="example">python manage.py sqlindexes app-name
</pre>

<p>
A combination of all the SQL from the 'sql', 'sqlinitialdata', and 'sqlindexes' commands.

</p>

<pre class="example">python manage.py sqlall app-name
</pre>

<h4>Database Migration</h4>

<p>
在Django 1.7之后加上了database migration功能。根据models的变化生成database变更脚本：

</p>

<pre class="example">python manage.py makemigrations &lt;app_name&gt;
</pre>

<p>
执行database变更：

</p>

<pre class="example">python manage.py migrate
</pre>

<h4>To invoke the Python shell with prj-name on sys.path and setting the settings.py as DJANGO_SETTINGS_MODULE environment variable</h4>

<pre class="example">python manage.py shell
</pre>

<h4>To use Django environment</h4>

<pre class="example">export PYTHONPATH=/home/sam/www/
export DJANGO_SETTINGS_MODULE=django-proj.settings
</pre>

<h4>A example of django configuration for Apache2.x with mod_python</h4>

<pre class="example">&lt;VirtualHost *:80&gt;
        ServerName apple
        ServerAlias apple.cn
        ServerAdmin cyberpsyche@gmail.com

        RewriteEngine On
        RewriteRule ^/tqyb/$ /banana.py?m=home [L]
        DocumentRoot /home/sam/www/apple/
        &lt;Directory /&gt;
                Options Indexes FollowSymLinks
                AllowOverride None
        &lt;/Directory&gt;
        &lt;Directory /home/sam/www/apple/&gt;
                Options Indexes FollowSymLinks
                AllowOverride None
                Order allow,deny
                Allow from all
        &lt;/Directory&gt;

        &lt;Location &quot;/apple/&quot;&gt;
                SetHandler mod_python
                PythonHandler django.core.handlers.modpython
                PythonPath &quot;['/home/sam/www'] + sys.path&quot;
                SetEnv DJANGO_SETTINGS_MODULE apple.settings
                PythonDebug On
                PythonAutoReload On
                #AddHandler mod_python .py
                #PythonHandler mptest
                #PythonDebug On
                Options Indexes FollowSymLinks
                Order allow,deny
                Allow from all
        &lt;/Location&gt;

        &lt;Location &quot;/media/&quot;&gt;
                SetHandler None
        &lt;/Location&gt;

        &lt;LocationMatch &quot;\.(jpg|gif|png)$&quot;&gt;
                SetHandler None
        &lt;/LocationMatch&gt;
        ErrorLog /home/sam/www/apple/logs/error.log
        LogLevel warn

        CustomLog /home/sam/www/apple/logs/access.log combined
&lt;/VirtualHost&gt;
</pre>

<h4>Django gzip response on the fly</h4>

<pre class="example">MIDDLEWARE_CLASSES = (
    ...
    'django.middleware.gzip.GZipMiddleware',
)
</pre>

<h4>Check Version of Django</h4>

<pre class="example">&gt; import django
&gt; django.VERSION
</pre>

<h4>Django 多语言</h4>

<p>
python manage.py makemessages -l zh-cn  //中文简体

</p>

<p>
在根目录的locale/LANG/LC_MESSAGES目录下创建一个django.po文件

</p>

<pre class="example">#: path/to/python/module.py:23
msgid &quot;Welcome to my site.&quot;
msgstr &quot;&quot;
</pre>

<p>
这三行内容各自代表下面的意思：

</p>

<p>
• 第一行通过注释表达该条要翻译的字符串在视图或模版中的位置；

</p>

<p>
• msgid：要翻译的字符串。不要修改它。

</p>

<p>
• msgstr：翻译后的文本。一开始它是空的，需要翻译人员逐条填写。

</p>

<p>
执行：

</p>

<pre class="example">django-admin compilemessages
</pre>

<p>
Django将自动搜索所有的.po文件，将它们都翻译成.mo文件。

</p>

<h4>issue with crispy_forms</h4>

<p>
修改 crispy_forms/templatetags/crispy_forms_utils.py 

</p>

<pre class="example">try:
    from django.utils.functional import keep_lazy as allow_lazy
except ImportError
    from django.utils.functional import allow_lazy
</pre>

<h4>Issue with users model in zinnia and cookiecutter-django integration</h4>

<p>
I found that is a 'bug' on Zinnia by the way that loads User model.

</p>

<p>
In zinnia/models/author.py:

</p>

<pre class="example">def safe_get_user_model():
    &quot;&quot;&quot;
    Safe loading of the User model, customized or not.
    &quot;&quot;&quot;
    user_app, user_model = settings.AUTH_USER_MODEL.split('.')
    return apps.get_registered_model(user_app, user_model)
</pre>

<p>
I changed it as:

</p>

<pre class="example">[...]
from django.contrib.auth import get_user_model
[...]
def safe_get_user_model():
    &quot;&quot;&quot;
    Safe loading of the User model, customized or not.
    &quot;&quot;&quot;
    # user_app, user_model = settings.AUTH_USER_MODEL.split('.')
    # return apps.get_registered_model(user_app, user_model)
    return get_user_model()
</pre>

<h4>Django 变量不转义html输出</h4>

<p>
方法一：

</p>

<pre class="example">{{ var | safe }}
</pre>

<p>
方法二：

</p>

<p>
对于代码块使用autoescape标签

</p>

<pre class="example">{ % autoescape off %}
{{ body }}
{ % endautoescape %}
</pre>

<p>
标签autoescape接受on或者off参数

</p>

<h4>Django ORM</h4>

<p>
Entry.objects.all().filter(pub_date__gt=datetime.date(2009, 1, 3)).order_by('-pub_date')

</p>

<p>
order_by 中的变量加'-'，表示逆序。

</p>

<p>
Entry.objects.get(headline__icontains='Lennon')

</p>

<p>
icontains 表示 Case-insensitive。

</p>

<h3>Psyco</h3>

<p>
加速python程序。

</p>

<h3>Twisted</h3>

<h4>twisted_server.py</h4>

<pre class="example">from twisted.internet import reactor,protocol
from twisted.protocols import basic

class PublishProtocol(basic.LineReceiver):
    def __init__(self):
        pass

    def lineReceived(self,line):
        if line == 'quit':
            self.sendLine(&quot;Goodbye.&quot;)
            self.transport.loseConnection()
        else:
            self.sendLine(line)

    def connectionMade(self):
        pass

    def connectionLost(self,reason):
        pass

class PublishServerFactory(protocol.ServerFactory):
    protocol = PublishProtocol

    def __init__(self):
        pass

    def startFactory(self):
        pass

    def stopFactory(self):
        pass

if __name__ == &quot;__main__&quot;:
    port=5001
    reactor.listenTCP(port,PublishServerFactory())
    reactor.run()
</pre>

<h4>twisted_client.py</h4>

<pre class="example">from twisted.internet import reactor,protocol

class QuickDisconnectProtocol(protocol.Protocol):
    def connectionMade(self):
        print &quot;Connected to %s.&quot;%self.transport.getPeer().host
        self.transport.write(&quot;Hello&quot;)
        self.transport.write('\r\n')
        #self.transport.read()
        self.transport.loseConnection()

    def dataReceived(self,data):
        self.transport.write(data)

class BasicClientFactory(protocol.ClientFactory):
    protocol=QuickDisconnectProtocol
    def clientConnectionLost(self,connector,reason):
        print 'Lost connection: %s'%reason.getErrorMessage()
        reactor.stop()
    def clientConnectionFailed(self,connector,reason):
        print 'Connection failed: %s'%reason.getErrorMessage()
        reactor.stop()

if __name__ == &quot;__main__&quot;:
    if sys.argv[1] == &quot;&quot;:

    reactor.connectTCP('10.10.243.100',5001,BasicClientFactory())
    reactor.run()
</pre>

<h3>Tornado </h3>

<p>
A non-block async IO web server framework created by Friendfeed.com, open sourced by Facebook.com

</p>

<h3>Python  Module by C language</h3>

<h4>C module source file</h4>

<pre class="example">#include &lt;Python.h&gt; 
static PyObject * seri07_system(PyObject * self, PyObject * args)
{
    char *command;
    int sts;
    if (!PyArg_ParseTuple(args, &quot;s&quot;, &amp;command))
        return NULL;
    sts = system(command);
    return Py_BuildValue(&quot;i&quot;, sts);
}
static PyMethodDef Seri07Methods[] = {
    {&quot;system&quot;, seri07_system, METH_VARARGS,
     &quot;Execute a shell command.&quot;},
    {NULL, NULL, 0, NULL}      
};
void initseri07(void)
{
    Py_InitModule(&quot;seri07&quot;, Seri07Methods);
}
</pre>

<h4>Module build</h4>

<p>
Build a setup.py file

</p>

<pre class="example">from distutils.core import setup, Extension
module1 = Extension('seri07',
                 sources = ['seri07module.c'])
setup (name = 'seri07 package',
    version = '1.0',
    description = 'This is a seri07 package',
    ext_modules = [module1])
</pre>

<p>
Build 

</p>

<pre class="example">$ python setup.py build
$ cp build/lib.linux-i686-2.5/seri07.so .
</pre>

<p>
Use the built module

</p>

<pre class="example">import seri07
seri07.system('ls')
</pre>

<h3>Python 技巧</h3>

<h4>Python 编译</h4>

<p>
编译test.py为test.pyc文件:

</p>

<pre class="example">import py_compile
py_compile.compile('test.py')
</pre>

<h4>列表操作</h4>

<pre class="example">[ k.upper() for k in list_A if k.isalpha() ]
</pre>

<h4>将一个列表逆序</h4>

<pre class="example">a = (1, 2, 3)
b = a[::-1]
b == (3, 2, 1)
</pre>

<h4>去字串空格</h4>

<p>
s.strip() == s.rstrip().lstrip()

</p>

<h4>lambda语句</h4>

<p>
匿名函数表仅在定义匿名函数的地方使用这个函数， 形如 lambda 参数列表:返回值表达式。 省略了return关键字。

</p>

<pre class="example">&gt;&gt;&gt; lambda x,y: x+y
&lt;function &lt;lambda&gt; at 0x000001B2DE5BD598&gt;
&gt;&gt;&gt; (lambda x,y: x+y)(3,4) # 因为匿名函数没有名字，使用的时候要用括号把它包起来
&gt;&gt;&gt; a = [{'name':'B', 'age':50}, {'name':'A', 'age':30}, {'name':'C', 'age':40}]
&gt;&gt;&gt; sorted(a, key=lambda x:x['name']) # 按姓名排序
[{'name': 'A', 'age': 30}, {'name': 'B', 'age': 50}, {'name': 'C', 'age': 40}]
&gt;&gt;&gt; sorted(a, key=lambda x:x['age']) # 按年龄排序
[{'name': 'A', 'age': 30}, {'name': 'C', 'age': 40}, {'name': 'B', 'age': 50}]
</pre>

<h4>print + end 的用法</h4>

<pre class="example">&gt;&gt;&gt; a = [1,2,3]
&gt;&gt;&gt; for i in a:
...    print(i, end=&quot;...&quot;)
1...2...3...
</pre>

<h4>md5</h4>

<pre class="example">import hashlib
m = hashlib.md5('strings')
m.hexdigest()

&gt;&gt;&gt; '8bcf6629759bd278a5c6266bd9c054f8'
</pre>

<h4>datetime函数操作</h4>

<p>
now = datetime.datetime.now()

</p>

<p>
strdatetime = now.strftime("%Y-%m-%d %H:%M:%S")

</p>

<p>
字符串生成datetime对象

</p>

<p>
datetime.datetime.strptime(strdatetime, "%Y-%m-%d %H:%M:%S.%f")

</p>

<p>
d2 = d1 + datetime.timedelta(hours=0.5)

</p>

<h4>time 函数操作</h4>

<p>
now = time.localtime()
now_stamp = time.mktime(now) #1590334232.0
t = time.strptime(time_str, "%Y-%m-%d %H:%M:%S")
time_str = time.strftime("%Y-%m-%dT%H:%M:%S", t)

</p>

<h4>两个列表生成对应的dict</h4>

<pre class="example">&gt;&gt;&gt; a = ['a', 'b', 'c']
&gt;&gt;&gt; b = [1, 2, 3]
&gt;&gt;&gt; zip(a,b)
&lt;zip object at 0x101ce2a08&gt;
&gt;&gt;&gt; dict(zip(a,b))
{'a': 1, 'b': 2, 'c': 3}
</pre>

<h4>用*号进行重复操作</h4>

<pre class="example">&gt;&gt;&gt; print(&quot;*&quot; * 20)
********************
</pre>

<h4>合并两个dict (python 3.5以上使用，python2中使用update()合并)</h4>

<pre class="example">&gt;&gt;&gt; dict_1 = {'apple': 9, 'banana': 6}
&gt;&gt;&gt; dict_2 = {'banana': 4, 'orange': 8}
&gt;&gt;&gt; combined_dict = {**dict_1, **dict_2}
&gt;&gt;&gt; print(combined_dict)
{'apple': 9, 'banana': 4, 'orange': 8}
</pre>

<p>
在两个字典存在交集的时候，则使用后一个进行覆盖。

</p>

<h4>map</h4>

<p>
给序列的每个元素应用一个函数，返回一个迭代器。

</p>

<pre class="example">l = [1,2,3,4]
result = map(lambda x: x**2, l)
list(result)
</pre>

<h4>reduce</h4>

<p>
reduce(function, iterable)

</p>

<p>
使用function(x,y)函数，将序列缩减为1个元素结果

</p>

<pre class="example">l = [1,2,3,4]
from functools import reduce
reduce(lambda x,y: x+y, l)
</pre>

<h4>filter</h4>

<p>
filter(function, iterable)

</p>

<p>
使用返回bool的function对序列过滤，返回满足条件的结果

</p>

<pre class="example">l = range(10)
result = filter(lambda x: x%2==0, l)
list(result)
</pre>

<h4>Counter</h4>

<p>
计数器，用于追踪值的出现次数。Counter类继承于dict类，故其可使用dict类里的方法。

</p>

<pre class="example">import collections
counter = collections.Counter(['a','b', 'c','a','b','a'])
counter
</pre>

<p>
Output: Counter({'a':3, 'b':2, 'c':1})

</p>

<p>
使用update可以往Counter中新增内容

</p>

<pre class="example">counter.update(['c','b','c','d','c'])
counter
</pre>

<p>
Output: Counter({'a':3, 'b':3, 'c':4, 'd':1})

</p>

<p>
可像字典一样输出key/value

</p>

<pre class="example">for key,value in counter.items():
    print(key, value)
</pre>

<p>
可方便的输出最高频率的数据

</p>

<pre class="example">counter.most_common(3)
</pre>

<p>
Output: [('c', 4), ('a', 3), ('b', 3)]

</p>

<h4>defaultdict</h4>

<p>
可省略初始化的dict。

</p>

<p>
dict = defaultdict(factory_function)

</p>

<p>
factory_function可以是str, int, list, set, 可省略初始化。

</p>

<pre class="example">from collections import defaultdict
dint = defaultdict(int)
dint['a'] += 3
</pre>

<h4>groupby</h4>

<p>
按照指定key进行数据分组： groupby(iterable, key=None)

</p>

<pre class="example">data = [
    {'id':1, &quot;title&quot;:&quot;AAA&quot;, &quot;category&quot;:&quot;java&quot;},
    {'id':2, &quot;title&quot;:&quot;BBB&quot;, &quot;category&quot;:&quot;python&quot;},
    {'id':3, &quot;title&quot;:&quot;CCC&quot;, &quot;category&quot;:&quot;c++&quot;},
    {'id':4, &quot;title&quot;:&quot;DDD&quot;, &quot;category&quot;:&quot;c++&quot;},
    {'id':5, &quot;title&quot;:&quot;EEE&quot;, &quot;category&quot;:&quot;java&quot;},
    {'id':6, &quot;title&quot;:&quot;FFF&quot;, &quot;category&quot;:&quot;python&quot;},
    {'id':7, &quot;title&quot;:&quot;GGG&quot;, &quot;category&quot;:&quot;java&quot;},
]

from itertools import groupby
data = sorted(data, key=lambda x:x[&quot;category&quot;]) # 先作排序
result = groupby(data, key=lambda x:x[&quot;category&quot;])
list(result)
&lt;example&gt;

*** json

&lt;example&gt;
import json
json.loads() # 将json数据转化成dict数据
json.dumps() # 将dict数据转化成json数据
json.load() # 读取json文件数据，转成dict数据
json.dump() # 将dict数据转化成json数据后写入json文件
</pre>

<p>
读取json文件，并转为dict:

</p>

<pre class="example">with open('.../XXX.json','r') as f:
    data= json.load(f)
或者：
data = json.load(open('.../XXX.json','r'))
</pre>

<p>
将dict数据转化为json，并写入json文件:

</p>

<pre class="example">with open('json_data.txt','w+') as f:
    json.dump(dict_data,f)
</pre>

<h4>with ... as 语句</h4>

<p>
基本思想是with所求值的对象必须有一个__enter__()方法，一个__exit__()方法。紧跟with后面的语句被求值后，返回对象的__enter__()方法被调用，这个方法的返回值将被赋值给as后面的变量。当with后面的代码块全部被执行完之后，将调用前面返回对象的__exit__()方法。 with还可以很好的处理上下文环境产生的异常，一般在__exit__()函数中处理清理资源，关闭文件等操作。

</p>

<pre class="example">    def __exit__(self, type, value, trace):
        print &quot;type:&quot;, type
        print &quot;value:&quot;, value
        print &quot;trace:&quot;, trace
</pre>

<h4>* 与 ** 的用法</h4>

<p>
（1） Python 函数支持默认参数和可变参数，一颗星*表示不限数量的单值参数，两颗星**表示不限数量的键值对参数。但必须按顺序使用。

</p>

<pre class="example">&gt;&gt;&gt; def do_something(name, age, gender='男', *args, **kwds):
	print('姓名：%s，年龄：%d，性别：%s'%(name, age, gender))
	print(args)
	print(kwds)

&gt;&gt;&gt; do_something('xufive', 50, '男', 175, 75, math=99, english=90)
姓名：xufive，年龄：50，性别：男
(175, 75)
{'math': 99, 'english': 90}
</pre>

<p>
（2）一颗星*和两颗星**还可用于列表、元组、字典的解包

</p>

<pre class="example">&gt;&gt;&gt; b = [1,2,3]
&gt;&gt;&gt; print(b)
[1, 2, 3]
&gt;&gt;&gt; print(*b)
1 2 3
&gt;&gt;&gt; c = {'name':'xufive', 'age':51}
&gt;&gt;&gt; print(c)
{'name': 'xufive', 'age': 51}
&gt;&gt;&gt; print(*c)
name age
&gt;&gt;&gt; print('name:{name}, age:{age}'.format(**c))
name:xufive, age:51
</pre>

<h4>三元表达式</h4>

<pre class="example">&gt;&gt;&gt; y = 5
&gt;&gt;&gt; x = -1 if y &lt; 0 else 1
&gt;&gt;&gt; x
1
</pre>

<h4>数组中插入数组</h4>

<pre class="example">&gt;&gt;&gt; a = [0, 1, 2, 3, 4, 5]
&gt;&gt;&gt; b = ['a', 'b']
&gt;&gt;&gt; a[2:2] = b
&gt;&gt;&gt; a
[0, 1, 'a', 'b', 2, 3, 4, 5]
</pre>

<h4>Python 3.X 里不包含 has_key() 函数，被 __contains__(key) 替代</h4>

<pre class="example">&gt;&gt;&gt; dict3 = {'name':'z','Age':7,'class':'First'}
&gt;&gt;&gt; print(&quot;Value : &quot;,dict3.__contains__('name'))
&gt;&gt;&gt; print(&quot;Value : &quot;,dict3.__contains__('sex'))
</pre>

<h4>time(), perf_counter(), process_counter() 的异同</h4>

<p>
time.time()返回纪元以来的秒数，更改系统时间会影响到time()的取值。

</p>

<p>
time.perf_counter()返回性能记数器的值，以小数秒为单位，使用最高时间分辨率，用于测量系统范围的短持续时间，在测试代码性能时会计入sleep()时间。

</p>

<p>
time.process_time()计算当前进程的系统和用户CPU时间总和值，以小数秒为单位，不包括sleep()休眠时间。

</p>

<p>
python3.7后提供 time.time_ns(), time.perf_counter_ns(), time.process_time_ns() 三个方法精确到纳秒，注意返回值为整型。

</p>

<p>
time.clock()方法在python3.8后废除，建议改用 time.process_time()

</p>

<h4>生成器和迭代器 yield</h4>

<p>
generator（生成器）,  iterator（迭代器）。目的是减少内存开销。

</p>

<h4>python代码加密</h4>

<p>
加密脚本setup.py的代码如下：

</p>

<pre class="example">from distutils.core import setup
from Cython.Build import cythonize
setup(ext_modules = cythonize([&quot;mytest.py&quot;]))
</pre>

<p>
将setup.py置于类文件夹中，执行:

</p>

<pre class="example">python3 setup.py build_ext
</pre>

<p>
设置 PYTHONPATH 到 so 的目录。

</p>

<h3>pip</h3>

<h4>升级包，包括pip本身</h4>

<p>
pip3 install --upgrade pip

</p>

<p>
pip3 install --upgrade Django

</p>

<h3>pipenv  --- 不再需要virtualenv和pip了</h3>

<h4>构建环境或克隆环境</h4>

<pre class="example">cd proj_dir
pipenv install
</pre>

<p>
以生成Pipfile, Pipfile.lock

</p>

<h4>安装包或卸载包</h4>

<pre class="example">pipenv install package_name
pipenv uninstall package_name
pipenv install --dev package_name  //只在开发环境安装
pipenv uninstall --all  //卸载所有包
</pre>

<h4>在环境下运行命令</h4>

<pre class="example">pipenv run ...
</pre>

<h4>查看所有需要更新的包</h4>

<pre class="example">pipenv update --outdated
</pre>

<h4>升级环境下所有的包</h4>

<pre class="example">pipenv update
</pre>

<h4>升级更新指定的包</h4>

<pre class="example">pipenv update &lt;包名&gt;
</pre>

<h4>安装指定版本的包</h4>

<pre class="example">pipenv install package_name==1.2.3
</pre>

<h4>指定Python版本</h4>

<pre class="example">pipenv --python 3
pipenv --python 3.6
</pre>

<h4>查看环境下包的依赖关系</h4>

<pre class="example">pipenv graph
</pre>

<h4>环境下的shell</h4>

<pre class="example">pipenv shell
</pre>

<h4>Lock</h4>

<p>
生成Pipenv.lock

</p>

<pre class="example">pipenv lock
</pre>

<p>
用下面的命令就可以将Pipfile和Pipfile.lock文件里面的包导出为requirements.txt文件。

</p>

<pre class="example">pipenv lock -r
</pre>

<p>
如果只想导出开发用的包，可以添加--dev参数：

</p>

<pre class="example">pipenv lock -r --dev
</pre>

<h4>删除环境</h4>

<pre class="example">pipenv --rm
</pre>

<h3>supervisor</h3>

<p>
注意: supervisor的原理为将一般进程作为其子进程进行管理，故supervisor不能监控后台Daemon进程，command 不能为后台运行命令。

</p>

<p>
pip3 install supervisor

</p>

<p>
创建 supervisord.conf :

</p>

<pre class="example">echo_supervisord_conf &gt; supervisord.conf
</pre>

<p>
典型配置文件

</p>

<pre class="example">[unix_http_server]
file=/tmp/supervisor.sock   ; (the path to the socket file)
chmod=0700                 ; socket file mode (default 0700)

;[inet_http_server]         ; inet (TCP) server disabled by default
;port=127.0.0.1:9001        ; (ip_address:port specifier, *:port for all iface)
;username=user              ; (default is no username (open server))
;password=123               ; (default is no password (open server))

[supervisord]
logfile=/opt/logs/supervisord.log ; (main log file;default $CWD/supervisord.log)
pidfile=/tmp/supervisord.pid ; (supervisord pidfile;default supervisord.pid)
nodaemon=true               ; (start in foreground if true;default false)
minfds=1024                  ; (min. avail startup file descriptors;default 1024)
minprocs=200                 ; (min. avail process descriptors;default 200)

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///tmp/supervisor.sock ; use a unix:// URL  for a unix socket
;serverurl=http://127.0.0.1:9001 ; use an http:// url to specify an inet socket


[include]
files = /etc/program.conf
</pre>

<p>
注意，为使supervisorctl可以控制，需要打开[rpcinterface:supervisor]配置。

</p>

<h4>supervisor + celery</h4>

<p>
编辑supervisord.conf，在最后增加下列内容：

</p>

<pre class="example">[program:celery.worker]
command=/usr/local/sbin/celery -A tasks worker --loglevel info --logfile celery_worker.log
directory=/home/sam/Projects/xxx-proj
stdout_logfile=/data/logs/celery.log
;启动设置
numprocs=1          ;进程数
autostart=true      ;当supervisor启动时,程序将会自动启动
autorestart=true    ;自动重启

;停止信号,默认TERM
;中断:INT (类似于Ctrl+C)(kill -INT pid)，退出后会将写文件或日志(推荐)
;终止:TERM (kill -TERM pid)
;挂起:HUP (kill -HUP pid),注意与Ctrl+Z/kill -stop pid不同
;从容停止:QUIT (kill -QUIT pid)
stopsignal=INT

;输出日志
stdout_logfile=celery_worker.log
stdout_logfile_maxbytes=10MB  ;默认最大50M
stdout_logfile_backups=10     ;日志文件备份数，默认为10

;错误日志
redirect_stderr=false         ;为true表示禁止监听错误, stderr转发至stdout中。
stderr_logfile=celery_worker_err.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=10
</pre>

<h4>supervisor + gunicorn</h4>

<p>
用法见 <a href="WebServerNotes.html">WebServerNotes</a>

</p>

<h4>supervisor 动态读入supervisord.conf 更新，并enact 更新：</h4>

<p>
sudo supervisorctl reread

</p>

<p>
sudo supervisorctl update

</p>

<h4>supervisor 控制</h4>

<p>
supervisorctl 打开控制器终端

</p>

<p>
sudo supervisorctl stop <app_name>

</p>

<p>
sudo supervisorctl restart <app_name>

</p>

<p>
sudo supervisorctl status

</p>

<p>
sudo supervisorctl -c supervisord.conf reload

</p>

<h3>gunicorn</h3>

<p>
pip3 install gunicorn

</p>

<p>
用法见 <a href="WebServerNotes.html">WebServerNotes</a>

</p>

<h3>celery</h3>

<p>
启动异步进程

</p>

<p>
celery -A celery_app worker -l info

</p>

<p>
启动 Celery Beat 进程

</p>

<p>
celery beat -A celery_app

</p>

<p>
同时启动Beat和Async进程：

</p>

<p>
celery -B -A celery_app worker --loglevel=info

</p>

<p>
BROKER_URL

</p>

<p>
BROKER_URL = 'amqp://sam:123456@localhost:5672/%2Fhollywood'

</p>

<p>
用%2F代表 '/'
</p><!-- Page published by Emacs Wiki ends here -->
    <div class="navfoot">
      <hr />
      <table width="100%" border="0" summary="Footer navigation">
        <col width="33%"/><col width="34%"/><col width="33%"/>
        <tr>
          <td align="left">Update : 2020-06-10
          </td>
          <td align="center">
           <span class="foothome">
              <a href="WelcomePage.html">Home</a> / <a href="WikiIndex.html">Index</a>
            </span>
          </td>
          <td align="right">
           cyberpsyche[AT]gmail.com
          </td>
        </tr>
      </table>
   <center>
     Based on
      <a href="http://www.debian.org"><img style="border: 0em none;" src="images/debianLogo.png" alt="Debian Logo" /></a>    
   <a href="http://www.debian.org"><img style="border: 0em none;" src="images/debian.png" alt="Debian Text Logo" /></a>   
       GNU/Linux&nbsp;and&nbsp;<a href="http://www.apple.com"><img style="border: 0em none;" src="images/MacLogo.jpg" alt="Mac Logo" /></a>OS X|&nbsp;Powered by    
      <a href="http://www.gnu.org/software/emacs"><img style="border: 0em none;" src="images/emacs.gif" alt="Emacs Logo" /></a>&nbsp;|   
      Best view with    
   <a href="http://www.getfirefox.com/"><img style="border: 0em none;" src="images/getFirefox.gif" alt="Firefox Logo" /></a> 
  </center>  
  </div>
  </body>
</html>